# This file is a template, and might need editing before it works on your project.
# use the official gcc image, based on debian
# can use verions as well, like gcc:5.2
# see https://hub.docker.com/_/gcc/

stages:
    - build
    - test

build:ubuntu_latest:
    image: ubuntu:latest

    # Install dependencies
    before_script:
        - apt-get update &&
          apt-get upgrade -y &&
          apt-get install -y
            build-essential
            autotools-dev
            automake
            autoconf
            libtool
            pkg-config
            libboost-system-dev
            libboost-filesystem-dev
            libboost-program-options-dev
            libboost-thread-dev
            libboost-regex-dev
            libprotobuf-dev
            protobuf-compiler
            libprotobuf-c-dev
            protobuf-c-compiler
            libyaml-cpp-dev
            libyaml-dev
            libcap2-bin
          
    # Build and test
    script:
        - ./bootstrap.sh
        - mkdir build && cd build
        - ../configure --enable-tests
        - make -j4
        - cd tests
        - make -j4 api
        - NORNS_DEBUG_OUTPUT_TO_STDERR=1 NORNS_DEBUG_CONFIG_FILE_OVERRIDE=1 ./api 2> /tmp/test_logs/stderr.log
